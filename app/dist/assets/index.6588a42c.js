import{l as u,r as b}from"./vendor.189e6465.js";const f=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerpolicy&&(i.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?i.credentials="include":s.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}};f();class p{constructor(){this.et=new EventTarget,this.body=document.querySelector("body"),this.et.addEventListener("settingup",e=>{e.detail?this.body.classList.add("settingup"):this.body.classList.remove("settingup")})}start(){this.et.dispatchEvent(new CustomEvent("settingup",{detail:!0}))}stop(){this.et.dispatchEvent(new CustomEvent("settingup",{detail:!1}))}}class y{constructor(){this.et=new EventTarget,this.feed=document.querySelector("#feed"),this.typing=document.querySelector("#is-typing"),this.noBubbleMessage=document.querySelector("#no-bubble"),this.bubbles=localStorage.getItem("bubbles"),this.parsedBubbles=JSON.parse(this.bubbles)}async init(){await this.loadFeed(),this.scrollDown(),this.et.addEventListener("to-WHTF",e=>{this.createBubble("me",e.detail)}),this.et.addEventListener("me-received",e=>{this.createBubble("WHTF",e.detail)})}sendTo(e,t){e==="WHTF"&&this.et.dispatchEvent(new CustomEvent("to-WHTF",{detail:t}))}receivedFrom(e,t){e==="WHTF"&&this.et.dispatchEvent(new CustomEvent("me-received",{detail:t}))}isTyping(e,t){e==="WHTF"&&(t?this.enableTyping():t===!1&&this.disableTyping())}enableTyping(){this.typing.classList.contains("on")||this.typing.classList.add("on")}disableTyping(){this.typing.classList.contains("on")&&this.typing.classList.remove("on")}scrollDown(){this.feed.scrollTo(0,this.feed.scrollHeight)}loadFeed(){return new Promise(e=>{if(this.parsedBubbles===null||this.parsedBubbles.length===0)this.noBubbleMessage.classList.remove("hide"),localStorage.setItem("bubbles",JSON.stringify([])),this.parsedBubbles=[],e();else for(let t=0;t<this.parsedBubbles.length;t+=1){const r=this.parsedBubbles[t];this.createBubble(r.who,r.string,!1),t+1===this.parsedBubbles.length&&setTimeout(()=>{e()},100)}})}createBubble(e,t,r=!0){const s=document.createElement("div"),i=document.createElement("p");s.className=`bubble-container ${e}`,i.className="bubble",i.innerHTML=t,this.feed.appendChild(s).appendChild(i),r&&this.saveBubble(e,t)}saveBubble(e,t){this.noBubbleMessage.classList.contains("hide")||this.noBubbleMessage.classList.add("hide"),this.parsedBubbles.length===62&&this.parsedBubbles.shift(),this.parsedBubbles.push({who:e,string:t}),this.scrollDown()}}class g{constructor(e,t,r,s){this.client=e,this._input=r,this.serverUrl=t,this.socket=u(this.serverUrl),this.history=localStorage.getItem("history"),this.parsedHistory=[],this.info=s,this.chatbot=new y,this._recorder={}}set input(e){typeof e!="undefined"&&(this._input.value=e)}set recorder(e){this._recorder=e}get recorder(){return this._recorder}init(){this.chatbot.init(),this.socket.on("connect",()=>{this.socket.emit("init",this.client)}),this.socket.on("answer",e=>{this.chatbot.receivedFrom("WHTF",e)}),this.socket.on("is-typing",e=>{this.chatbot.isTyping("WHTF",e)}),this.socket.on("recognized",(e,t)=>{this._input.value=e,this.send("query"),t("string-received")}),this.socket.on("audio-forwarded",(e,t)=>{const r=new AudioContext,s=r.createBufferSource();r.decodeAudioData(e.buffer,i=>{s.buffer=i,s.connect(r.destination),s.start(0),this.info.after_speech&&e.is_final_answer&&setTimeout(()=>{this._recorder.start(),this._recorder.enabled=!0;const n=setInterval(()=>{this._recorder.enabled&&this._recorder.countSilenceAfterTalk<=8&&(this._recorder.countSilenceAfterTalk===8?(this._recorder.stop(),this._recorder.enabled=!1,this._recorder.countSilenceAfterTalk=0,clearInterval(n)):this._recorder.noiseDetected?clearInterval(n):this._recorder.countSilenceAfterTalk+=1)},1e3)},e.duration+500)})}),this.history!==null&&(this.parsedHistory=JSON.parse(this.history))}send(e){return this._input.value!==""?(this.socket.emit(e,{client:this.client,value:this._input.value.trim()}),this.chatbot.sendTo("WHTF",this._input.value),this.save(),!0):!1}save(){let e=this._input.value;localStorage.getItem("history")===null?(localStorage.setItem("history",JSON.stringify([])),this.parsedHistory=JSON.parse(localStorage.getItem("history"))):this.parsedHistory.length>=32&&this.parsedHistory.shift(),e[0]===" "&&(e=e.substr(1,e.length-1)),this.parsedHistory[this.parsedHistory.length-1]!==e&&(this.parsedHistory.push(e),localStorage.setItem("history",JSON.stringify(this.parsedHistory))),this._input.value=""}}let l=-1,c=null;const m=(o,e)=>{const t=o.which||o.keyCode;localStorage.getItem("history")!==null&&(t===38||t===40)&&(c=JSON.parse(localStorage.getItem("history")).reverse()),t===13?e.send("query")&&(c=JSON.parse(localStorage.getItem("history")).reverse(),l=-1):localStorage.getItem("history")!==null&&(t===38&&l<c.length-1?(l+=1,e.input=c[l]):t===40&&l-1>=0?(l-=1,e.input=c[l]):t===40&&l-1<0&&(e.input="",l=-1))},v=(o,e)=>{o.altKey&&o.key==="t"&&e()},d={app:"webapp",server_host:"http://192.168.1.5",server_port:"1339",min_decibels:-40,max_blank_time:1e3},h="";document.body.classList.add("settingup");document.addEventListener("DOMContentLoaded",()=>{const o=new p;o.start(),b.get(`${h}/info`).end((e,t)=>{if(e||!t.ok)console.error(e);else{const r=document.querySelector("#query"),s=document.querySelector("button"),i=new g(d.app,h,r,t.body);let n={enabled:!1};i.init(),annyang.addCallback("resultNoMatch",function(a){i.socket.emit("query",{client:d.app,value:a[0]}),i.chatbot.sendTo("WHTF",a[0])}),annyang.start(),o.stop(),document.addEventListener("keydown",a=>{v(a,()=>{n.enabled===!1?(r.value="",n.enabled=!0):n.enabled=!1})}),r.addEventListener("keydown",a=>{m(a,i)}),s.addEventListener("click",a=>{a.preventDefault(),n.enabled===!1?n.enabled=!0:n.enabled=!1})}})});
